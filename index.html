<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cargando...</title>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;700;800&family=Space+Mono&display=swap" rel="stylesheet"/>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #080b12;
      --surface: #0f1420;
      --accent: #00f0a0;
      --accent2: #0055ff;
      --text: #e8eaf0;
      --muted: #4a5068;
      --error: #ff3b5c;
      --warn: #ffb800;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Syne', sans-serif;
      min-height: 100dvh;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image:
        linear-gradient(rgba(0,240,160,0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0,240,160,0.03) 1px, transparent 1px);
      background-size: 40px 40px;
      pointer-events: none;
    }

    body::after {
      content: '';
      position: fixed;
      width: 600px;
      height: 600px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(0,85,255,0.12) 0%, transparent 70%);
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      pointer-events: none;
    }

    .card {
      position: relative;
      z-index: 10;
      background: var(--surface);
      border: 1px solid rgba(0,240,160,0.12);
      border-radius: 20px;
      padding: 48px 40px;
      width: min(420px, 92vw);
      text-align: center;
      box-shadow: 0 0 60px rgba(0,0,0,0.6), 0 0 0 1px rgba(255,255,255,0.04) inset;
    }

    .icon-wrap {
      width: 72px;
      height: 72px;
      margin: 0 auto 28px;
      position: relative;
    }
    .icon-ring {
      position: absolute;
      inset: 0;
      border-radius: 50%;
      border: 2px solid transparent;
      background: linear-gradient(var(--surface), var(--surface)) padding-box,
                  linear-gradient(135deg, var(--accent), var(--accent2)) border-box;
      animation: spin 2.4s linear infinite;
    }
    .icon-inner {
      position: absolute;
      inset: 10px;
      border-radius: 50%;
      background: linear-gradient(135deg, rgba(0,240,160,0.15), rgba(0,85,255,0.15));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    h1 {
      font-size: 1.4rem;
      font-weight: 800;
      letter-spacing: -0.02em;
      margin-bottom: 8px;
    }

    #status {
      font-family: 'Space Mono', monospace;
      font-size: 0.75rem;
      color: var(--muted);
      min-height: 1.4em;
      transition: color 0.3s;
      word-break: break-all;
    }
    #status.ok    { color: var(--accent); }
    #status.error { color: var(--error); }
    #status.warn  { color: var(--warn); }

    .progress-wrap {
      margin: 28px 0 20px;
      height: 3px;
      background: rgba(255,255,255,0.06);
      border-radius: 99px;
      overflow: hidden;
    }
    .progress-bar {
      height: 100%;
      width: 0%;
      border-radius: 99px;
      background: linear-gradient(90deg, var(--accent2), var(--accent));
      transition: width 0.4s ease;
      box-shadow: 0 0 12px var(--accent);
    }

    .steps {
      display: flex;
      flex-direction: column;
      gap: 10px;
      text-align: left;
    }
    .step {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 0.82rem;
      color: var(--muted);
      transition: color 0.3s;
    }
    .step.active { color: var(--text); }
    .step.done   { color: var(--accent); }
    .step.fail   { color: var(--error); }

    .step-dot {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 1.5px solid currentColor;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      font-size: 10px;
      transition: all 0.3s;
    }
    .step.active .step-dot { animation: pulse-dot 1s ease-in-out infinite; }
    .step.done .step-dot   { background: var(--accent); border-color: var(--accent); color: #000; }
    .step.fail .step-dot   { background: var(--error);  border-color: var(--error);  color: #fff; }

    @keyframes pulse-dot {
      0%, 100% { box-shadow: 0 0 0 0 currentColor; opacity: 1; }
      50%       { box-shadow: 0 0 0 5px transparent; opacity: 0.7; }
    }

    #debug-box {
      display: none;
      margin-top: 16px;
      padding: 12px;
      background: rgba(0,240,160,0.05);
      border: 1px solid rgba(0,240,160,0.15);
      border-radius: 10px;
      font-family: 'Space Mono', monospace;
      font-size: 0.68rem;
      color: var(--muted);
      text-align: left;
      line-height: 1.9;
    }

    #error-block {
      display: none;
      margin-top: 24px;
      padding: 16px;
      background: rgba(255,59,92,0.08);
      border: 1px solid rgba(255,59,92,0.2);
      border-radius: 10px;
    }
    #error-block p {
      font-size: 0.82rem;
      color: var(--error);
      line-height: 1.5;
    }
    #error-block .err-icon { font-size: 1.4rem; margin-bottom: 6px; }
  </style>
</head>
<body>
<div class="card">

  <div class="icon-wrap">
    <div class="icon-ring"></div>
    <div class="icon-inner">üîê</div>
  </div>

  <h1>Verificando acceso</h1>
  <p id="status">Iniciando...</p>

  <div class="progress-wrap">
    <div class="progress-bar" id="progress"></div>
  </div>

  <div class="steps">
    <div class="step" id="s1">
      <div class="step-dot">1</div>
      <span>Verificando conexi√≥n</span>
    </div>
    <div class="step" id="s2">
      <div class="step-dot">2</div>
      <span>Solicitando ubicaci√≥n</span>
    </div>
    <div class="step" id="s3">
      <div class="step-dot">3</div>
      <span>Validando zona permitida</span>
    </div>
    <div class="step" id="s4">
      <div class="step-dot">4</div>
      <span>Redirigiendo...</span>
    </div>
  </div>

  <div id="debug-box"></div>

  <div id="error-block">
    <div class="err-icon">üö´</div>
    <p id="error-msg"></p>
  </div>

</div>

<script>
  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     ‚úèÔ∏è  CONFIGURA AQU√ç TUS VALORES
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  const TARGET_URL  = "https://soporteapp.gcalidad.com";   // ‚Üê URL destino
  const ALLOWED_LAT = 37.899996;       // ‚Üê Latitud del lugar permitido
  const ALLOWED_LNG = -4.733057;      // ‚Üê Longitud del lugar permitido
  const RADIUS_M    = 200;             // ‚Üê Radio permitido en metros

  // true = muestra info de depuraci√≥n en pantalla (√∫salo para probar)
  // false = producci√≥n, sin info visible
  const DEBUG = true;
  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */


  const progressEl = document.getElementById('progress');
  const statusEl   = document.getElementById('status');
  const debugBox   = document.getElementById('debug-box');

  function setStep(id, state) {
    const el  = document.getElementById(id);
    const dot = el.querySelector('.step-dot');
    el.className = 'step ' + state;
    if (state === 'done') dot.textContent = '‚úì';
    else if (state === 'fail') dot.textContent = '‚úó';
  }

  function setProgress(pct) {
    progressEl.style.width = pct + '%';
  }

  function setStatus(msg, cls) {
    statusEl.textContent = msg;
    statusEl.className = cls || '';
  }

  function showError(msg) {
    setStatus(msg, 'error');
    document.getElementById('error-block').style.display = 'block';
    document.getElementById('error-msg').textContent = msg;
  }

  function showDebug(data) {
    if (!DEBUG) return;
    debugBox.style.display = 'block';
    debugBox.innerHTML = Object.entries(data)
      .map(([k, v]) => `<div><b>${k}:</b> ${v}</div>`)
      .join('');
  }

  function haversineDistance(lat1, lng1, lat2, lng2) {
    const R = 6371000;
    const toRad = x => x * Math.PI / 180;
    const dLat = toRad(lat2 - lat1);
    const dLng = toRad(lng2 - lng1);
    const a = Math.sin(dLat/2)**2 +
              Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLng/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }

  function delay(ms) {
    return new Promise(r => setTimeout(r, ms));
  }

  function getLocation() {
    return new Promise((resolve, reject) => {
      if (!navigator.geolocation) {
        reject({ code: 0, message: 'Geolocalizaci√≥n no soportada.' });
        return;
      }
      navigator.geolocation.getCurrentPosition(resolve, reject, {
        enableHighAccuracy: true,
        timeout: 20000,
        maximumAge: 0
      });
    });
  }

  async function run() {

    // ‚îÄ‚îÄ Paso 1: Conexi√≥n ‚îÄ‚îÄ
    setStep('s1', 'active');
    setStatus('Verificando conexi√≥n...');
    setProgress(10);
    await delay(700);
    setStep('s1', 'done');
    setProgress(25);

    // ‚îÄ‚îÄ Paso 2: GPS ‚îÄ‚îÄ
    // Actualizamos la UI primero y esperamos 300ms para que el navegador
    // pinte la pantalla ANTES de lanzar el popup de permiso de ubicaci√≥n
    setStep('s2', 'active');
    setStatus('Toca "Permitir" cuando el navegador pida tu ubicaci√≥n...', 'warn');
    setProgress(35);
    await delay(300);

    let position;
    try {
      position = await getLocation();
    } catch (err) {
      setStep('s2', 'fail');
      setStep('s3', 'fail');
      setStep('s4', 'fail');
      setProgress(40);
      const msgs = {
        1: 'Permiso denegado. Activa la ubicaci√≥n en tu navegador e intenta de nuevo.',
        2: 'Ubicaci√≥n no disponible. Aseg√∫rate de tener el GPS activo.',
        3: 'Tiempo agotado esperando GPS. Intenta de nuevo.',
        0: 'Tu navegador no soporta geolocalizaci√≥n.'
      };
      showError(msgs[err.code] || 'Error desconocido al obtener ubicaci√≥n.');
      return;
    }

    setStep('s2', 'done');
    setProgress(60);

    // ‚îÄ‚îÄ Paso 3: Validar zona ‚îÄ‚îÄ
    setStep('s3', 'active');
    setStatus('Validando zona permitida...');
    await delay(400);

    const { latitude, longitude, accuracy } = position.coords;

    // Si el GPS devuelve (0,0) es una se√±al de que no funcion√≥ correctamente
    if (latitude === 0 && longitude === 0) {
      setStep('s3', 'fail');
      setStep('s4', 'fail');
      setProgress(70);
      showDebug({ '‚ö†Ô∏è': 'GPS devolvi√≥ (0,0) ‚Äî ubicaci√≥n inv√°lida' });
      showError('No se pudo obtener una ubicaci√≥n v√°lida. Verifica que el GPS est√© activado.');
      return;
    }

    const distance = Math.round(haversineDistance(latitude, longitude, ALLOWED_LAT, ALLOWED_LNG));

    showDebug({
      'üìç Tu ubicaci√≥n':    `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`,
      'üéØ Lugar permitido': `${ALLOWED_LAT}, ${ALLOWED_LNG}`,
      'üìè Distancia':       `${distance} m`,
      '‚úÖ Radio m√°ximo':    `${RADIUS_M} m`,
      'üì° Precisi√≥n GPS':   `${Math.round(accuracy)} m`,
      'üîç Resultado':       distance <= RADIUS_M ? '‚úì Dentro del √°rea' : '‚úó Fuera del √°rea'
    });

    // En debug dejamos m√°s tiempo para leer los valores
    await delay(DEBUG ? 2500 : 400);

    if (distance > RADIUS_M) {
      setStep('s3', 'fail');
      setStep('s4', 'fail');
      setProgress(75);
      showError(`Acceso denegado. Est√°s a ${distance} m del √°rea permitida (m√°ximo ${RADIUS_M} m).`);
      return;
    }

    setStep('s3', 'done');
    setProgress(85);

    // ‚îÄ‚îÄ Paso 4: Redirigir ‚îÄ‚îÄ
    setStep('s4', 'active');
    setStatus('Acceso verificado. Redirigiendo...', 'ok');
    await delay(800);
    setStep('s4', 'done');
    setProgress(100);
    await delay(400);

    window.location.href = TARGET_URL;
  }

  run();
</script>
</body>
</html>
