<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acceso Inteligente NFC</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900 text-white min-h-screen flex items-center justify-center p-4">

    <div id="auth-card" class="bg-white text-slate-800 p-8 rounded-2xl shadow-2xl w-full max-w-sm">
        <h2 id="auth-title" class="text-2xl font-bold mb-6 text-center text-blue-600">Identificación</h2>
        
        <div id="step-1">
            <input type="text" id="user-input" placeholder="Introduce tu usuario" class="w-full border-2 p-3 rounded-lg mb-4 outline-blue-500">
            <button onclick="verificarUsuario()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700">Continuar</button>
        </div>

        <div id="step-login" class="hidden text-center">
            <p class="mb-4 text-gray-600">Bienvenido de nuevo, <span id="display-name" class="font-bold"></span></p>
            <input type="password" id="pass-login" placeholder="Contraseña" class="w-full border-2 p-3 rounded-lg mb-4">
            <button onclick="loginFinal()" class="w-full bg-emerald-500 text-white font-bold py-3 rounded-lg">Entrar</button>
        </div>

        <div id="step-register" class="hidden">
            <p class="mb-4 text-orange-600 text-sm font-semibold">Usuario no encontrado. Regístrate:</p>
            <input type="password" id="pass-reg" placeholder="Crea una contraseña" class="w-full border-2 p-3 rounded-lg mb-4">
            <input type="text" id="extra-info" placeholder="Nombre completo" class="w-full border-2 p-3 rounded-lg mb-6">
            <button onclick="registrarNuevo()" class="w-full bg-orange-500 text-white font-bold py-3 rounded-lg">Crear Cuenta</button>
        </div>

        <div id="loader" class="hidden mt-4 text-center animate-pulse text-blue-500 font-bold">Procesando...</div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbziQAC8bDHI8fHYHx1pp_0TjB4NyWt6cci7YxFgBohPW6Rg7rnnx9LJU6Rf-Rqsz2HpcQ/exec";
        let tempUser = "";
        let correctPass = "";

        async function verificarUsuario() {
            tempUser = document.getElementById('user-input').value.trim();
            if(!tempUser) return alert("Escribe un usuario");

            mostrarLoader(true);
            
            try {
                // Consultamos al Google Sheet si el usuario existe
                const res = await fetch(`${SCRIPT_URL}?user=${tempUser}`);
                const data = await res.json();

                document.getElementById('step-1').classList.add('hidden');
                mostrarLoader(false);

                if(data.exists) {
                    // SI EXISTE
                    document.getElementById('step-login').classList.remove('hidden');
                    document.getElementById('display-name').innerText = tempUser;
                    correctPass = data.pass;
                    document.getElementById('auth-title').innerText = "Iniciar Sesión";
                } else {
                    // NO EXISTE
                    document.getElementById('step-register').classList.remove('hidden');
                    document.getElementById('auth-title').innerText = "Nuevo Registro";
                }
            } catch (e) {
                alert("Error de conexión");
                mostrarLoader(false);
            }
        }

        async function registrarNuevo() {
            const pass = document.getElementById('pass-reg').value;
            const info = document.getElementById('extra-info').value;

            if(!pass || !info) return alert("Rellena todos los campos");

            // Guardar en Google Sheets (POST)
            await fetch(SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({
                    usuario: tempUser,
                    password: pass,
                    accion: "REGISTRO NUEVO: " + info
                })
            });

            alert("Cuenta creada. Ya puedes entrar.");
            location.reload();
        }

        function loginFinal() {
            const pass = document.getElementById('pass-login').value;
            if(pass === correctPass.toString()) {
                localStorage.setItem('user_authenticated', 'true');
                localStorage.setItem('user_name', tempUser);
                alert("Acceso concedido");
                // Aquí rediriges a tu URL final de tareas
                window.location.href = "https://tu-url-de-tareas.com?user=" + tempUser;
            } else {
                alert("Contraseña incorrecta");
            }
        }

        function mostrarLoader(show) {
            document.getElementById('loader').classList.toggle('hidden', !show);
        }
    </script>
</body>
</html>
