<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexo de Validación NFC</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900 text-white flex items-center justify-center min-h-screen">

    <div id="loading" class="text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500 mx-auto"></div>
        <p class="mt-4 text-gray-400">Verificando credenciales...</p>
    </div>

    <div id="login-screen" class="hidden bg-white text-slate-900 p-8 rounded-2xl shadow-2xl w-full max-w-sm mx-4">
        <h2 class="text-2xl font-bold mb-2 text-center">Identificación</h2>
        <p class="text-sm text-gray-500 mb-6 text-center">Escanee un punto o inicie sesión</p>
        
        <input type="text" id="user-input" placeholder="Usuario" class="w-full border p-3 rounded mb-4 outline-blue-500">
        <input type="password" id="pass-input" placeholder="Contraseña" class="w-full border p-3 rounded mb-6 outline-blue-500">
        
        <button onclick="intentarLogin()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition">
            Acceder al Sistema
        </button>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxI-Hd40ACG6oYIInX6xGmYufB5XuEO2SgbcPeSfiN7dYaqjrm6K-ssmF4TOfOmOQDiQQ/exec"; 
        const URL_WEB_TAREAS = "https://tu-sitio-web-de-tareas.com"; // <--- TU URL FINAL AQUÍ

        // 1. Al cargar, comprobamos si ya hay una sesión guardada en el móvil
        window.onload = function() {
            const sessionActive = localStorage.getItem('user_authenticated');
            const params = new URLSearchParams(window.location.search);
            const puntoID = params.get('punto'); // Captura el ID del NFC

            if (sessionActive === 'true') {
                // SI ESTÁ LOGUEADO: Registrar en Sheets y redirigir
                registrarYRedirigir(localStorage.getItem('user_name'), puntoID);
            } else {
                // NO ESTÁ LOGUEADO: Mostrar login
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('login-screen').classList.remove('hidden');
            }
        };

        function intentarLogin() {
            const user = document.getElementById('user-input').value;
            const pass = document.getElementById('pass-input').value;

            if (user && pass === "1234") {
                // Guardar sesión en el navegador del móvil (no se borra al cerrar)
                localStorage.setItem('user_authenticated', 'true');
                localStorage.setItem('user_name', user);
                
                const params = new URLSearchParams(window.location.search);
                registrarYRedirigir(user, params.get('punto') || "Login Manual");
            } else {
                alert("Credenciales incorrectas");
            }
        }

        function registrarYRedirigir(usuario, punto) {
            // Enviamos a Google Sheets para dejar constancia de la lectura física
            fetch(SCRIPT_URL, {
                method: "POST",
                mode: "no-cors",
                body: JSON.stringify({
                    usuario: usuario,
                    accion: "Lectura NFC - Redirección",
                    id_tarjeta: punto
                })
            }).then(() => {
                // Redirigir a la web de tareas con el ID del punto para que la web sepa qué tarea mostrar
                window.location.href = URL_WEB_TAREAS + "?punto=" + punto;
            });
        }
    </script>
</body>
</html>
